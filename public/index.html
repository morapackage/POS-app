<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SmartPay - Onboarding & Payment</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background: #f8f9fa; }
    .container { max-width: 800px; margin-top: 40px; }
    .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .logo-bar { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
    .logo-bar img { height: 40px; }
    #paymentForm { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-bar">
      <img src="https://dwolla.com/wp-content/uploads/2021/06/dwolla-logo.svg" alt="Dwolla">
      <img src="https://upload.wikimedia.org/wikipedia/commons/4/4a/Visa_2021.svg" alt="Visa">
      <img src="https://upload.wikimedia.org/wikipedia/commons/b/b7/MasterCard_Logo.svg" alt="MasterCard">
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/American_Express_logo_%282018%29.svg" alt="Amex">
    </div>
    <div class="card p-4">
      <h3 class="text-center mb-3">Customer Onboarding</h3>
      <form id="customerForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label>First Name</label>
            <input type="text" class="form-control" name="firstName" required>
          </div>
          <div class="col-md-6">
            <label>Last Name</label>
            <input type="text" class="form-control" name="lastName" required>
          </div>
          <div class="col-md-6">
            <label>Email</label>
            <input type="email" class="form-control" name="email" required>
          </div>
          <div class="col-md-6">
            <label>Date of Birth</label>
            <input type="date" class="form-control" name="dateOfBirth" required>
          </div>
          <div class="col-md-6">
            <label>SSN (Last 4)</label>
            <input type="text" class="form-control" name="ssn" maxlength="4" required>
          </div>
          <div class="col-md-6">
            <label>Address</label>
            <input type="text" class="form-control" name="address1" required>
          </div>
          <div class="col-md-4">
            <label>City</label>
            <input type="text" class="form-control" name="city" required>
          </div>
          <div class="col-md-4">
            <label>State</label>
            <input type="text" class="form-control" name="state" required>
          </div>
          <div class="col-md-4">
            <label>Postal Code</label>
            <input type="text" class="form-control" name="postalCode" required>
          </div>
          <div class="col-md-6">
            <label>Routing Number</label>
            <input type="text" class="form-control" name="routingNumber" required>
          </div>
          <div class="col-md-6">
            <label>Account Number</label>
            <input type="text" class="form-control" name="accountNumber" required>
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-3">Submit</button>
      </form>
      <div id="response" class="alert mt-3 d-none"></div>

      <!-- Payment Section -->
      <form id="paymentForm" class="mt-4">
        <h4 class="mb-3">Make a Payment</h4>
        <div class="mb-3">
          <label>Amount ($)</label>
          <input type="number" class="form-control" name="amount" step="0.01" min="1" required>
        </div>
        <button type="submit" class="btn btn-success w-100">Pay Now</button>
      </form>
      <div id="paymentResponse" class="alert mt-3 d-none"></div>
    </div>
  </div>

  <script>
    let fundingSourceUrl = null; // store after onboarding

    document.getElementById("customerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(e.target).entries());
      const responseDiv = document.getElementById("response");

      try {
        // Step 1: Create customer
        let res = await fetch("/api/create-customer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData)
        });
        let data = await res.json();
        if (!res.ok) throw new Error(JSON.stringify(data.errors));
        const customerUrl = data.customerUrl;

        // Step 2: Add funding source
        res = await fetch("/api/add-funding-source", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            customerUrl,
            routingNumber: formData.routingNumber,
            accountNumber: formData.accountNumber
          })
        });
        data = await res.json();
        if (!res.ok) throw new Error(JSON.stringify(data.errors));
        fundingSourceUrl = data.fundingSourceUrl;

        // Step 3: Initiate micro-deposits
        res = await fetch("/api/initiate-micro-deposits", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fundingSourceUrl })
        });
        data = await res.json();
        if (!res.ok) throw new Error(JSON.stringify(data.errors));

        responseDiv.className = "alert alert-success mt-3";
        responseDiv.textContent = "✅ Customer onboarded. Micro-deposits sent for verification. You can now make a test payment once verified.";
        responseDiv.classList.remove("d-none");

        document.getElementById("paymentForm").style.display = "block";
      } catch (err) {
        responseDiv.className = "alert alert-danger mt-3";
        responseDiv.textContent = "❌ Error: " + err.message;
        responseDiv.classList.remove("d-none");
      }
    });

    // Handle Payment
    document.getElementById("paymentForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const amount = new FormData(e.target).get("amount");
      const paymentDiv = document.getElementById("paymentResponse");

      try {
        let res = await fetch("/api/make-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fundingSourceUrl, amount })
        });
        let data = await res.json();
        if (!res.ok) throw new Error(JSON.stringify(data.errors));

        paymentDiv.className = "alert alert-success mt-3";
        paymentDiv.textContent = "✅ Payment of $" + amount + " initiated successfully.";
        paymentDiv.classList.remove("d-none");
      } catch (err) {
        paymentDiv.className = "alert alert-danger mt-3";
        paymentDiv.textContent = "❌ Payment Error: " + err.message;
        paymentDiv.classList.remove("d-none");
      }
    });
  </script>
</body>
</html>
