<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SmartPay Wizard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .step { display: none; }
    .active { display: block; }
    .nav-buttons { margin-top: 20px; }
    button { padding: 8px 16px; margin: 5px; }
    input { display: block; margin: 8px 0; padding: 6px; width: 250px; }
    #toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; padding: 12px; border-radius: 6px; display: none; }
  </style>
</head>
<body>
  <h1>SmartPay Wizard</h1>

  <!-- Step 1: Customer Info -->
  <div id="step1" class="step active">
    <h2>Step 1: Customer Info</h2>
    <form id="customerForm">
      <input type="text" id="firstName" placeholder="First Name" required />
      <input type="text" id="lastName" placeholder="Last Name" required />
      <input type="email" id="email" placeholder="Email" required />
      <input type="text" id="address1" placeholder="Address" required />
      <input type="text" id="city" placeholder="City" required />
      <input type="text" id="state" placeholder="State" required />
      <input type="text" id="postalCode" placeholder="Postal Code" required />
      <input type="text" id="ssn" placeholder="SSN (last 4 digits)" required />
      <button type="submit">Create Customer</button>
    </form>
    <div class="nav-buttons">
      <button id="next1" disabled>Next</button>
    </div>
  </div>

  <!-- Step 2: Bank Info -->
  <div id="step2" class="step">
    <h2>Step 2: Bank Info</h2>
    <form id="bankForm">
      <input type="text" id="accountName" placeholder="Bank Account Name" required />
      <input type="text" id="routingNumber" placeholder="Routing Number" required />
      <input type="text" id="accountNumber" placeholder="Account Number" required />
      <select id="accountType" required>
        <option value="">Select Account Type</option>
        <option value="checking">Checking</option>
        <option value="savings">Savings</option>
      </select>
      <button type="submit">Add Bank</button>
    </form>
    <div class="nav-buttons">
      <button id="back2">Back</button>
      <button id="next2" disabled>Next</button>
    </div>
  </div>

  <!-- Step 3: Verify Bank -->
  <div id="step3" class="step">
    <h2>Step 3: Verify Bank Account</h2>

    <!-- Instant Verification -->
    <div id="iavSection">
      <p>Option 1: Verify instantly</p>
      <button id="iavButton">Verify Instantly</button>
      <p id="iavStatus"></p>
    </div>

    <hr>

    <!-- Manual Trial Deposit -->
    <div id="manualSection">
      <p>Option 2: Enter trial deposit amounts</p>
      <form id="verifyDepositsForm">
        <input type="number" step="0.01" id="amount1" placeholder="Amount 1 (e.g., 0.05)" required />
        <input type="number" step="0.01" id="amount2" placeholder="Amount 2 (e.g., 0.12)" required />
        <button type="submit">Verify Deposits</button>
      </form>
      <div id="verifyDepositsResult"></div>
    </div>

    <div class="nav-buttons">
      <button id="back3">Back</button>
      <button id="next3" disabled>Next</button>
    </div>
  </div>

  <!-- Step 4: Payment -->
  <div id="step4" class="step">
    <h2>Step 4: Payment</h2>
    <form id="paymentForm">
      <input type="number" step="0.01" id="amount" placeholder="Amount (e.g., 25.00)" required />
      <button type="submit">Submit Payment</button>
    </form>
    <div class="nav-buttons">
      <button id="back4">Back</button>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    let customerId = null;
    let fundingSourceId = null;
    let iavLink = null;

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 3000);
    }

    function goToStep(step) {
      document.querySelectorAll(".step").forEach(div => div.classList.remove("active"));
      document.getElementById("step" + step).classList.add("active");
    }

    // Step 1: Customer creation
    document.getElementById("customerForm").onsubmit = async (e) => {
      e.preventDefault();
      const res = await fetch("/api/create-customer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          firstName: firstName.value,
          lastName: lastName.value,
          email: email.value,
          address1: address1.value,
          city: city.value,
          state: state.value,
          postalCode: postalCode.value,
          ssn: ssn.value,
        }),
      });
      const data = await res.json();
      if (res.ok) {
        customerId = data.customerId;
        showToast("✅ Customer created!");
        document.getElementById("next1").disabled = false;
      } else {
        showToast("❌ Error: " + data.message);
      }
    };

    document.getElementById("next1").onclick = () => goToStep(2);

    // Step 2: Add bank
    document.getElementById("bankForm").onsubmit = async (e) => {
      e.preventDefault();
      const res = await fetch("/api/add-bank", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          customerId,
          accountName: accountName.value,
          routingNumber: routingNumber.value,
          accountNumber: accountNumber.value,
          accountType: accountType.value,
        }),
      });
      const data = await res.json();
      if (res.ok) {
        fundingSourceId = data.fundingSourceId;
        iavLink = data.iavLink;
        showToast("✅ Bank added!");
        document.getElementById("next2").disabled = false;
      } else {
        showToast("❌ Error: " + data.message);
      }
    };

    document.getElementById("next2").onclick = () => goToStep(3);
    document.getElementById("back2").onclick = () => goToStep(1);

    // Step 3: Verification
    document.getElementById("iavButton").onclick = () => {
      window.open(iavLink, "_blank");
      document.getElementById("iavStatus").textContent = "✅ Bank verified instantly!";
      document.getElementById("next3").disabled = false;
    };

    document.getElementById("verifyDepositsForm").onsubmit = async (e) => {
      e.preventDefault();
      const res = await fetch("/api/verify-deposits", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ fundingSourceId, amounts: [amount1.value, amount2.value] }),
      });
      const data = await res.json();
      if (res.ok) {
        document.getElementById("verifyDepositsResult").textContent = "✅ Bank verified!";
        document.getElementById("next3").disabled = false;
      } else {
        document.getElementById("verifyDepositsResult").textContent = "❌ Error: " + data.message;
      }
    };

    document.getElementById("next3").onclick = () => goToStep(4);
    document.getElementById("back3").onclick = () => goToStep(2);

    // Step 4: Payment
    document.getElementById("paymentForm").onsubmit = async (e) => {
      e.preventDefault();
      const res = await fetch("/api/payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ fundingSourceId, amount: amount.value }),
      });
      const data = await res.json();
      if (res.ok) {
        showToast("✅ Payment successful!");
      } else {
        showToast("❌ Error: " + data.message);
      }
    };

    document.getElementById("back4").onclick = () => goToStep(3);
  </script>
</body>
</html>
