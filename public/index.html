<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartPay Wizard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#f6f8fb; font-family: Inter, system-ui, Arial; }
    .card { border-radius:12px; box-shadow: 0 6px 18px rgba(20,20,40,0.06); }
    .step-badge { width:34px; height:34px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; background:#e9eefc; color:#0d6efd; font-weight:700; }
    .hidden { display:none !important; }
    pre { background:#0b1220; color:#dbeafe; padding:12px; border-radius:8px; overflow:auto; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>SmartPay — Onboarding Wizard</h3>
          <div>
            <span class="badge bg-secondary">Sandbox</span>
          </div>
        </div>

        <div class="card p-4 mb-3">
          <div class="mb-3">
            <small class="text-muted">Follow the steps: 1 → 2 → 3 → 4 → 5</small>
          </div>

          <!-- Step 1: Customer -->
          <div id="step1">
            <h5><span class="step-badge">1</span> Customer Info</h5>
            <form id="customerForm" class="row g-2 mt-2">
              <div class="col-md-6">
                <input class="form-control" name="firstName" placeholder="First name" required />
              </div>
              <div class="col-md-6">
                <input class="form-control" name="lastName" placeholder="Last name" required />
              </div>
              <div class="col-md-6">
                <input type="email" class="form-control" name="email" placeholder="Email" required />
              </div>
              <div class="col-md-6">
                <input class="form-control" name="phone" placeholder="Phone" />
              </div>
              <div class="col-12">
                <input class="form-control" name="address1" placeholder="Address line 1" required />
              </div>
              <div class="col-md-6">
                <input class="form-control" name="city" placeholder="City" required />
              </div>
              <div class="col-md-3">
                <input class="form-control" name="state" placeholder="State (2-letter)" maxlength="2" required />
              </div>
              <div class="col-md-3">
                <input class="form-control" name="postalCode" placeholder="Postal code" required />
              </div>
              <div class="col-md-6">
                <input type="date" class="form-control" name="dateOfBirth" placeholder="Date of birth" />
              </div>
              <div class="col-md-6">
                <input class="form-control" name="ssn" placeholder="SSN (last 4)" maxlength="4" required />
              </div>

              <div class="col-12">
                <button class="btn btn-primary" id="createCustomerBtn">
                  Create customer
                  <span id="cSpin" class="spinner-border spinner-border-sm ms-2 hidden"></span>
                </button>
              </div>
            </form>

            <div id="customerResult" class="mt-3 hidden">
              <h6>Customer created</h6>
              <div><strong>Customer URL:</strong> <span id="customerUrl"></span></div>
              <pre id="customerJson"></pre>
            </div>
          </div>

          <hr/>

          <!-- Step 2: Bank -->
          <div id="step2" class="mt-3">
            <h5><span class="step-badge">2</span> Bank Account</h5>
            <form id="bankForm" class="row g-2 mt-2">
              <div class="col-12">
                <input class="form-control" id="custUrlInput" placeholder="Customer URL (auto-filled)" required />
              </div>
              <div class="col-md-6"><input class="form-control" id="routing" placeholder="Routing number" required /></div>
              <div class="col-md-6"><input class="form-control" id="account" placeholder="Account number" required /></div>
              <div class="col-12">
                <input class="form-control" id="bankName" placeholder="Bank name (optional)" />
              </div>
              <div class="col-12">
                <button class="btn btn-primary" id="addBankBtn" disabled>
                  Add bank & send trial deposit
                  <span id="bSpin" class="spinner-border spinner-border-sm ms-2 hidden"></span>
                </button>
              </div>
            </form>

            <div id="bankResult" class="mt-3 hidden">
              <h6>Funding source</h6>
              <div><strong>Funding Source URL:</strong> <span id="fundingUrl"></span></div>
            </div>
          </div>

          <hr/>

          <!-- Step 3: Verify micro-deposits -->
          <div id="step3" class="mt-3">
            <h5><span class="step-badge">3</span> Verify deposits</h5>
            <div class="small text-muted mb-2">Enter the two deposit amounts received (sandbox auto-verifies for test values if you used the auto verify flow on server side).</div>
            <form id="verifyForm" class="row g-2">
              <div class="col-md-6"><input class="form-control" name="amount1" placeholder="Amount 1 (e.g. 0.01)" /></div>
              <div class="col-md-6"><input class="form-control" name="amount2" placeholder="Amount 2 (e.g. 0.02)" /></div>
              <div class="col-12">
                <button class="btn btn-primary" id="verifyBtn" disabled>
                  Verify deposits
                  <span id="vSpin" class="spinner-border spinner-border-sm ms-2 hidden"></span>
                </button>
              </div>
            </form>

            <div id="verifyResult" class="mt-3 hidden"></div>
          </div>

          <hr/>

          <!-- Step 4 & 5: Payment -->
          <div id="step4" class="mt-3">
            <h5><span class="step-badge">4</span> Submit payment</h5>
            <form id="paymentForm" class="row g-2">
              <div class="col-12">
                <input class="form-control" id="sourceFundingInput" placeholder="Funding Source URL (auto-filled)" required />
              </div>
              <div class="col-md-6"><input type="number" step="0.01" class="form-control" id="payAmount" placeholder="Amount (USD)" required /></div>
              <div class="col-md-6"><input class="form-control" id="destFundingInput" placeholder="Destination funding URL (optional, defaults to your master funding)" /></div>
              <div class="col-12">
                <button class="btn btn-success" id="payBtn" disabled>
                  Debit account (transfer)
                  <span id="pSpin" class="spinner-border spinner-border-sm ms-2 hidden"></span>
                </button>
              </div>
            </form>

            <div id="transferResult" class="mt-3 hidden"></div>
          </div>

        </div> <!-- card -->
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    // Step 1
    $("customerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide($("customerResult"));
      $("createCustomerBtn").disabled = true; show($("cSpin"));
      const fd = Object.fromEntries(new FormData(e.target).entries());

      try {
        const res = await fetch("/api/create-customer", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(fd) });
        const data = await res.json();
        if (!res.ok) throw data;
        $("customerUrl").textContent = data.customerUrl || "(no location returned)";
        $("customerJson").textContent = JSON.stringify(data.customer, null, 2);
        $("custUrlInput").value = data.customerUrl || "";
        show($("customerResult"));

        // enable bank step
        $("addBankBtn").disabled = false;
      } catch (err) {
        alert("Create customer failed: " + (err.error?.message || JSON.stringify(err)));
      } finally {
        $("createCustomerBtn").disabled = false; hide($("cSpin"));
      }
    });

    // Step 2: add bank
    $("bankForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide($("bankResult"));
      $("addBankBtn").disabled = true; show($("bSpin"));
      const body = {
        customerUrl: $("custUrlInput").value.trim(),
        routingNumber: $("routing").value.trim(),
        accountNumber: $("account").value.trim(),
        name: $("bankName").value.trim() || "Customer Bank"
      };

      try {
        const res = await fetch("/api/add-funding-source", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
        const data = await res.json();
        if (!res.ok) throw data;
        $("fundingUrl").textContent = data.fundingSourceUrl || "(no location returned)";
        $("sourceFundingInput").value = data.fundingSourceUrl || "";
        show($("bankResult"));
        // enable verify & pay
        $("verifyBtn").disabled = false;
        $("payBtn").disabled = false;
      } catch (err) {
        alert("Add bank failed: " + (err.error?.message || JSON.stringify(err)));
      } finally {
        $("addBankBtn").disabled = false; hide($("bSpin"));
      }
    });

    // Step 3: verify micro-deposits
    $("verifyForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide($("verifyResult"));
      $("verifyBtn").disabled = true; show($("vSpin"));
      const dataBody = {
        fundingSourceUrl: $("sourceFundingInput").value.trim(),
        amount1: new FormData(e.target).get("amount1"),
        amount2: new FormData(e.target).get("amount2")
      };

      try {
        const res = await fetch("/api/verify-microdeposits", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(dataBody) });
        const data = await res.json();
        if (!res.ok) throw data;
        $("verifyResult").classList.remove("hidden");
        $("verifyResult").textContent = data.message || "Verified";
        $("payBtn").disabled = false;
      } catch (err) {
        alert("Verify failed: " + (err.error?.message || JSON.stringify(err)));
      } finally {
        $("verifyBtn").disabled = false; hide($("vSpin"));
      }
    });

    // Step 4: make transfer/payment
    $("paymentForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide($("transferResult"));
      $("payBtn").disabled = true; show($("pSpin"));

      const body = {
        sourceFundingUrl: $("sourceFundingInput").value.trim(),
        destinationFundingUrl: $("destFundingInput").value.trim() || undefined,
        amount: $("payAmount").value.trim()
      };

      try {
        const res = await fetch("/api/transfer", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
        const data = await res.json();
        if (!res.ok) throw data;
        $("transferResult").classList.remove("hidden");
        $("transferResult").innerHTML = `<div><strong>Transfer created</strong></div><div>${data.transferUrl || ""}</div><pre>${JSON.stringify(data.details || data, null, 2)}</pre>`;
      } catch (err) {
        alert("Transfer failed: " + (err.error?.message || JSON.stringify(err)));
      } finally {
        $("payBtn").disabled = false; hide($("pSpin"));
      }
    });
  </script>
</body>
</html>
