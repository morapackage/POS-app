<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SmartPay - Dwolla Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    .container { display: flex; flex-direction: row; gap: 20px; }
    form { background: #fff; padding: 20px; border-radius: 12px; flex: 1; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; }
    input { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px; width: 100%; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:disabled { background: #aaa; }
    .logos { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .logos img { height: 40px; }
    #status { margin-top: 15px; font-weight: bold; }
    .spinner { display: none; margin-left: 10px; border: 3px solid #f3f3f3; border-top: 3px solid #4CAF50; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h1>SmartPay - Dwolla Integration</h1>
  <div class="logos">
    <img src="https://dwolla.com/wp-content/uploads/2020/05/Dwolla-Logo.svg" alt="Dwolla" />
    <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Visa_2014_logo_detail.svg" alt="Visa" />
    <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Mastercard-logo.png" alt="Mastercard" />
    <img src="https://upload.wikimedia.org/wikipedia/commons/3/30/Amex_logo.svg" alt="AmEx" />
    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" />
  </div>

  <div class="container">
    <form id="paymentForm">
      <h2>Create Customer & Payment</h2>
      <label>First Name <input name="firstName" required /></label>
      <label>Last Name <input name="lastName" required /></label>
      <label>Email <input type="email" name="email" required /></label>
      <label>Address <input name="address" required /></label>
      <label>City <input name="city" required /></label>
      <label>State <input name="state" required /></label>
      <label>Postal Code <input name="postalCode" required /></label>
      <label>SSN <input name="ssn" required /></label>
      <label>Date of Birth (YYYY-MM-DD) <input name="dob" required /></label>

      <label>Routing Number <input name="routingNumber" required /></label>
      <label>Account Number <input name="accountNumber" required /></label>
      <label>Bank Name <input name="bankName" required /></label>

      <label>Payment Amount (USD) <input name="amount" required /></label>

      <button type="submit">Submit <div class="spinner" id="spinner"></div></button>
      <div id="status"></div>
    </form>
  </div>

  <script>
    const form = document.getElementById("paymentForm");
    const statusDiv = document.getElementById("status");
    const spinner = document.getElementById("spinner");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusDiv.textContent = "";
      spinner.style.display = "inline-block";

      try {
        const data = Object.fromEntries(new FormData(form).entries());

        // 1 Create Customer
        let res = await fetch("/api/create-customer", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        let out = await res.json();
        if (!res.ok) throw out;
        const customerUrl = out.customerUrl;

        // 2 Add Bank
        res = await fetch("/api/add-bank", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ customerUrl, ...data }),
        });
        out = await res.json();
        if (!res.ok) throw out;
        const bankUrl = out.bankUrl;

        // 3 Trial Deposit
        await fetch("/api/trial-deposit", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ bankUrl }),
        });

        // 4 Payment (after verification, in sandbox we skip actual wait)
        res = await fetch("/api/payment", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ bankUrl, amount: data.amount }),
        });
        out = await res.json();
        if (!res.ok) throw out;

        statusDiv.textContent = "✅ " + out.message;
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "❌ Error: " + (err.message || JSON.stringify(err));
      } finally {
        spinner.style.display = "none";
      }
    });
  </script>
</body>
</html>
